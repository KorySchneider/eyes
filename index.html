<!DOCTYPE html>
<html>

<head>
  <title>eyes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/addons/p5.dom.min.js"></script>
  <script src="https://unpkg.com/ml5@0.1.2/dist/ml5.min.js" type="text/javascript"></script>
</head>

<style>
body, html {
  padding: 0;
  margin: 0;
  text-align: center;
  background-color: #000;
}
</style>

<body></body>

<script>
let video;
let poseNet;
let poses = [];

let eyeBoxSize = 40;

class Eye {
  constructor(img, x, y) {
    this.img = img;
    this.x = x;
    this.y = y;
  }
}

function setup() {
  noLoop(); // Don't start drawing until model is loaded
  frameRate(30);

  createCanvas(960, 720);
  video = createCapture(VIDEO);
  video.size(width, height);

  // Load model and start draw loop when finished
  poseNet = ml5.poseNet(video, 'multiple', loop);

  // Find poses every frame
  poseNet.on('pose', results => poses = results);

  video.hide(); // Hide video element, only draw canvas
}

function draw() {
  // Draw video frame image
  image(video, 0, 0, width, height);

  // If poses were detected in current frame
  if (poses) {
    // Find eyes
    let eyes = [];
    for (let i = 0; i < poses.length; i++) {
      for (let j = 1; j < 3; j++) {
        // Create Eye object for each eye found
        let eye = poses[i].pose.keypoints[j];
        if (eye.score > 0.25) { // Want to be fairly sure it's an eye
          eyes.push(
            new Eye(
              get( // Grab pixels
                eye.position.x - (eyeBoxSize/2),
                eye.position.y - (eyeBoxSize/2),
                eyeBoxSize,
                eyeBoxSize
              ),
              eye.position.x,
              eye.position.y
            )
          );
        }
      }
    }

    // Hide frame once we've used it to find poses
    fill(0);
    noStroke();
    rect(0, 0, width, height);

    // Draw all eyes found
    for (let i = 0; i < eyes.length; i++) {
      let eye = eyes[i];
      if (eye.img.pixels) {
        image(
          eye.img,
          eye.x - (eyeBoxSize/2),
          eye.y - (eyeBoxSize/2),
          eyeBoxSize,
          eyeBoxSize
        );
      }
    }
  }
}
</script>
</html>
